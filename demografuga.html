<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>DemograFuga - A Jornada do Futuro</title>
<style>
  body { margin: 0; background: #d0f4f7; overflow: hidden; font-family: Arial, sans-serif; }
  canvas { display: block; margin: 0 auto; background: #7ec850; }
  #questionBox {
    position: fixed;
    top: 20px; left: 50%; transform: translateX(-50%);
    width: 700px; background: white; border-radius: 8px;
    padding: 15px; box-shadow: 0 0 10px rgba(0,0,0,0.5);
    font-size: 16px;
    display: none;
    z-index: 10;
  }
  #questionBox p { margin: 10px 0; }
  #message {
    position: fixed;
    top: 10px; left: 50%; transform: translateX(-50%);
    font-size: 20px; color: red;
    font-weight: bold;
    display: none;
    z-index: 10;
  }
</style>
</head>
<body>
<canvas id="gameCanvas" width="800" height="400"></canvas>
<div id="questionBox">
  <p id="questionText"></p>
  <button id="option0"></button>
  <button id="option1"></button>
  <button id="option2" style="display:none;"></button>
  <button id="option3" style="display:none;"></button>
</div>
<div id="message"></div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

const groundLevel = 350;
const gravity = 0.5;

let gameState = {
  player: {
    x: 50,
    y: groundLevel,
    width: 30,
    height: 40,
    velocityY: 0,
    jumping: false,
    color: '#3b1e05' // placeholder player color
  },
  keys: {},
  currentPhaseIndex: 0,
  inFavela: false,
  questionActive: false,
  answeredQuestions: [],
  messageTimeout: null,
  win: false
};

const phases = [
  {
    name: "Zona Rural",
    background: '#7ec850',
    garrafinhas: [
      {
        x: 250, y: groundLevel - 30,
        question: "O que representa a pirâmide etária?",
        options: [
          "A) Distribuição por faixa de renda",
          "B) Distribuição por idade e sexo"
        ],
        answer: 1,
        answered: false
      },
      {
        x: 600, y: groundLevel - 30,
        question: "O que é crescimento vegetativo?",
        options: [
          "A) Diferença entre natalidade e mortalidade",
          "B) Crescimento por imigração"
        ],
        answer: 0,
        answered: false
      }
    ]
  },
  {
    name: "Periferia Urbana",
    background: '#b3c273',
    garrafinhas: [
      {
        x: 200, y: groundLevel - 30,
        question: "Qual é uma causa comum da migração campo-cidade?",
        options: [
          "A) Clima seco",
          "B) Busca por emprego e serviços"
        ],
        answer: 1,
        answered: false
      },
      {
        x: 550, y: groundLevel - 30,
        question: "Qual o maior desafio da periferia?",
        options: [
          "A) Falta de transporte",
          "B) Falta de saneamento básico"
        ],
        answer: 1,
        answered: false
      }
    ]
  },
  {
    name: "Escola Pública",
    background: '#a0c4ff',
    garrafinhas: [
      {
        x: 300, y: groundLevel - 30,
        question: "Qual é um direito garantido pela educação pública?",
        options: [
          "A) Educação gratuita e de qualidade",
          "B) Apenas ensino básico"
        ],
        answer: 0,
        answered: false
      },
      {
        x: 650, y: groundLevel - 30,
        question: "O que é importante para melhorar a escola pública?",
        options: [
          "A) Investimento em infraestrutura e professores",
          "B) Aumento do número de alunos"
        ],
        answer: 0,
        answered: false
      }
    ]
  },
  {
    name: "Favela (fase penalidade)",
    background: '#666666',
    garrafinhas: [
      {
        x: 400, y: groundLevel - 30,
        question: "Qual política ajuda a reduzir desigualdades urbanas?",
        options: [
          "A) Expansão de áreas sem planejamento",
          "B) Investimento em saneamento e educação"
        ],
        answer: 1,
        answered: false
      }
    ]
  },
  {
    name: "Centro Urbano",
    background: '#f3e2a9',
    garrafinhas: [
      {
        x: 350, y: groundLevel - 30,
        question: "O que a carteira de trabalho simboliza no Brasil?",
        options: [
          "A) Emprego formal e direitos trabalhistas",
          "B) Compra de imóveis"
        ],
        answer: 0,
        answered: false
      }
    ]
  }
];

let currentQuestion = null;

const questionBox = document.getElementById('questionBox');
const questionText = document.getElementById('questionText');
const optionButtons = [
  document.getElementById('option0'),
  document.getElementById('option1'),
  document.getElementById('option2'),
  document.getElementById('option3'),
];
const messageBox = document.getElementById('message');

function showMessage(text, time=2000) {
  if(gameState.messageTimeout) clearTimeout(gameState.messageTimeout);
  messageBox.textContent = text;
  messageBox.style.display = 'block';
  gameState.messageTimeout = setTimeout(() => {
    messageBox.style.display = 'none';
  }, time);
}

function showQuestion(questionObj) {
  gameState.questionActive = true;
  questionBox.style.display = 'block';
  questionText.textContent = questionObj.question;
  for(let i=0; i<4; i++) {
    if(questionObj.options[i]) {
      optionButtons[i].style.display = 'inline-block';
      optionButtons[i].textContent = questionObj.options[i];
      optionButtons[i].disabled = false;
    } else {
      optionButtons[i].style.display = 'none';
    }
  }
}

function hideQuestion() {
  gameState.questionActive = false;
  questionBox.style.display = 'none';
}

function resetPlayerPosition() {
  gameState.player.x = 50;
  gameState.player.y = groundLevel;
  gameState.player.velocityY = 0;
  gameState.player.jumping = false;
}

function fallToFavela() {
  gameState.inFavela = true;
  gameState.currentPhaseIndex = 3; // Favela
  resetPlayerPosition();
  showMessage("Você errou! Caiu na favela, responda para tentar sair!");
}

function checkWin() {
  const lastPhase = phases.length -1;
  if(gameState.currentPhaseIndex === lastPhase) {
    let allAnswered = phases[lastPhase].garrafinhas.every(q => q.answered);
    if(allAnswered) {
      gameState.win = true;
      showMessage("Parabéns! Você conquistou sua Carteira de Trabalho!");
    }
  }
}

function handleAnswer(selectedIndex) {
  if(!currentQuestion) return;
  if(selectedIndex === currentQuestion.answer) {
    currentQuestion.answered = true;
    showMessage("Resposta correta!");
    hideQuestion();
    currentQuestion = null;

    // Se estava na favela e respondeu certo, volta para a fase anterior (periferia)
    if(gameState.inFavela) {
      gameState.inFavela = false;
      gameState.currentPhaseIndex = 1; // Volta para periferia por exemplo
      resetPlayerPosition();
    }

    checkWin();
  } else {
    hideQuestion();
    currentQuestion = null;
    fallToFavela();
  }
}

optionButtons.forEach((btn, i) => {
  btn.addEventListener('click', () => {
    if(gameState.questionActive) {
      handleAnswer(i);
    }
  });
});

document.addEventListener('keydown', e => {
  if(gameState.questionActive) return; // trava movimento enquanto pergunta aberta
  gameState.keys[e.key.toLowerCase()] = true;
});
document.addEventListener('keyup', e => {
  gameState.keys[e.key.toLowerCase()] = false;
});

function update() {
  let p = gameState.player;
  const speed = 4;

  if(gameState.keys['arrowright'] || gameState.keys['d']) {
    p.x += speed;
  }
  if(gameState.keys['arrowleft'] || gameState.keys['a']) {
    p.x -= speed;
  }
  if((gameState.keys['arrowup'] || gameState.keys['w'] || gameState.keys[' ']) && !p.jumping) {
    p.velocityY = -10;
    p.jumping = true;
  }

  p.velocityY += gravity;
  p.y += p.velocityY;

  if(p.y > groundLevel) {
    p.y = groundLevel;
    p.velocityY = 0;
    p.jumping = false;
  }

  // Limites do mapa
  if(p.x < 0) p.x = 0;
  if(p.x > canvas.width - p.width) p.x = canvas.width - p.width;

  // Verifica colisão com garrafinhas da fase atual
  const phase = phases[gameState.currentPhaseIndex];
  for(let bottle of phase.garrafinhas) {
    if(!bottle.answered &&
      p.x < bottle.x + 20 &&
      p.x + p.width > bottle.x &&
      p.y + p.height > bottle.y &&
      p.y < bottle.y + 30
    ) {
      currentQuestion = bottle;
      showQuestion(currentQuestion);
      break;
    }
  }

  // Avança de fase se passar do lado direito (e não estiver respondendo pergunta)
  if(!gameState.questionActive && p.x > canvas.width - 40) {
    if(!gameState.inFavela && gameState.currentPhaseIndex < phases.length - 1) {
      gameState.currentPhaseIndex++;
      resetPlayerPosition();
    }
  }
}

function draw() {
  const phase = phases[gameState.currentPhaseIndex];
  // fundo
  ctx.fillStyle = phase.background;
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // chão
  ctx.fillStyle = "#654321";
  ctx.fillRect(0, groundLevel + 30, canvas.width, 70);

  // jogador (representado por retângulo simples aqui)
  ctx.fillStyle = gameState.player.color;
  ctx.fillRect(gameState.player.x, gameState.player.y, gameState.player.width, gameState.player.height);

  // garrafinhas
  ctx.fillStyle = '#0000FF';
  phase.garrafinhas.forEach(bottle => {
    if(!bottle.answered) {
      ctx.fillRect(bottle.x, bottle.y, 20, 30);
    }
  });

  // Texto da fase
  ctx.fillStyle = '#000';
  ctx.font = '20px Arial';
  ctx.fillText(`Fase: ${phase.name}`, 20, 30);

  if(gameState.inFavela) {
    ctx.fillStyle = 'red';
    ctx.font = '18px Arial';
    ctx.fillText('Você está na favela! Responda a pergunta para sair.', 200, 60);
  }

  if(gameState.win) {
    ctx.fillStyle = 'green';
    ctx.font = '30px Arial';
    ctx.fillText('Parabéns! Você conquistou a Carteira de Trabalho!', 150, 200);
  }
}

function gameLoop() {
  if(!gameState.win) update();
  draw();
  requestAnimationFrame(gameLoop);
}

gameLoop();
</script>
</body>
</html>
