<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>DemograFuga - A Jornada do Futuro</title>
<style>
  body { margin: 0; overflow: hidden; font-family: sans-serif; }
  canvas { display: block; background: #87ceeb; }
  #questionBox {
    position: fixed;
    top: 20px; left: 50%; transform: translateX(-50%);
    width: 60%; background: #fff; padding: 15px;
    border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.5);
    display: none; z-index: 10;
  }
  #questionBox p { margin: 0 0 10px; }
  #questionBox button { margin: 5px; }
</style>
</head>
<body>
<canvas id="gameCanvas" width="900" height="500"></canvas>
<div id="questionBox">
  <p id="questionText"></p>
  <button id="option0"></button>
  <button id="option1"></button>
  <button id="option2"></button>
  <button id="option3"></button>
</div>
<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const gravity = 0.6;
const groundLevel = 420;
let player = { x: 50, y: groundLevel, w: 30, h: 40, vy: 0, jumping: false };
let keys = {};

const images = {
  "zona_rural": new Image(zona_rural.jpeg),
  "periferia": new Image(periferia.jpeg),
  "escola_publica": new Image(escola.jpg),
  "nilo": new Image(nilo.gif),
  "garrafinha": new Image(garrafinha.gif),
  "esgoto": new Image(esgoto.jpeg),
  "carteira": new Image(carteira_de_trabalho.jpg),
  "favela": new Image(favela.jpg)
};
images["zona_rural"].src = "zona_rural.jpeg";
images["periferia"].src = "periferia.jpeg";
images["escola_publica"].src = "escola.jpg";
images["nilo"].src = "nilo.gif";
images["garrafinha"].src = "garrafinha.gif";
images["esgoto"].src = "esgoto.jpeg";
images["carteira"].src = "carteira_de_trabalho.jpg";
images["favela"].src = "favela.jpg";

let currentPhase = 0;
let showFinal = false;
let fireworks = [];

const allPeriferiaQuestions = [
  { q: "O que é êxodo rural?", options: ["Saída da cidade", "Saída do campo para cidade"], a: 1 },
  { q: "Qual problema comum nas periferias?", options: ["Saneamento básico", "Transporte aéreo"], a: 0 },
  { q: "O que pode melhorar a periferia?", options: ["Investimento público", "Privatização de rios"], a: 0 }
];
let periferiaUsed = [];

const phases = [
  {
    name: "Zona Rural",
    bg: images["zona_rural"],
    obstacles: [{x: 300, w: 40}, {x: 600, w: 60}],
    questions: [
      { x: 700, q: "O que é crescimento vegetativo?", options: ["Natalidade - Mortalidade", "Migração"] , a: 0, answered: false },
    ]
  },
  {
    name: "Periferia",
    bg: images["periferia"],
    obstacles: [{x: 250, w: 40}, {x: 500, w: 50}, {x: 750, w: 30}],
    questions: []
  },
  {
    name: "Escola Pública",
    bg: images["escola_publica"],
    obstacles: [{x: 350, w: 50}, {x: 650, w: 50}],
    questions: [
      { x: 700, q: "Qual direito é garantido na escola pública?", options: ["Educação gratuita", "Educação paga"], a: 0, answered: false },
    ]
  },
  {
    name: "Favela",
    bg: images["favela"],
    obstacles: [{x: 200, w: 50}, {x: 500, w: 60}],
    questions: [
      { x: 600, q: "Qual é um desafio enfrentado em muitas favelas?", options: ["Falta de infraestrutura", "Alta cobertura médica"], a: 0, answered: false }
    ]
  }
];

const questionBox = document.getElementById("questionBox");
const questionText = document.getElementById("questionText");
const optionButtons = [
  document.getElementById("option0"),
  document.getElementById("option1"),
  document.getElementById("option2"),
  document.getElementById("option3")
];

let currentQuestion = null;

function loadRandomPeriferiaQuestion() {
  let unused = allPeriferiaQuestions
    .map((q, i) => ({ ...q, index: i }))
    .filter(q => !periferiaUsed.includes(q.index));

  if (unused.length === 0) {
    periferiaUsed = [];
    unused = allPeriferiaQuestions.map((q, i) => ({ ...q, index: i }));
  }

  const random = unused[Math.floor(Math.random() * unused.length)];
  periferiaUsed.push(random.index);
  return { x: 600, ...random, answered: false };
}

function showQuestion(qObj) {
  currentQuestion = qObj;
  questionText.textContent = qObj.q;
  optionButtons.forEach((btn, i) => {
    btn.textContent = qObj.options[i] || "";
    btn.style.display = qObj.options[i] ? "inline-block" : "none";
    btn.onclick = () => checkAnswer(i);
  });
  questionBox.style.display = "block";
}

function checkAnswer(i) {
  questionBox.style.display = "none";
  if (i === currentQuestion.a) {
    currentQuestion.answered = true;
    if (currentPhase === 1) {
      currentPhase = 2;
      player.x = 50;
    } else if (currentPhase === 2 && phases[2].questions.every(q => q.answered)) {
      showFinal = true;
    } else if (currentPhase === 3) {
      currentPhase = 1;
      phases[1].questions = [loadRandomPeriferiaQuestion()];
      player.x = 50;
    }
  } else {
    currentPhase = 3; // Vai para Favela se errar
    player.x = 50;
  }
  currentQuestion = null;
}

document.addEventListener("keydown", e => keys[e.key] = true);
document.addEventListener("keyup", e => keys[e.key] = false);

function createFirework() {
  return {
    x: Math.random() * canvas.width,
    y: Math.random() * canvas.height / 2,
    r: Math.random() * 5 + 2,
    color: `hsl(${Math.random() * 360}, 100%, 50%)`,
    life: 60
  };
}

function isColliding(a, b) {
  return a.x < b.x + b.w &&
         a.x + a.w > b.x &&
         a.y < groundLevel + 40 &&
         a.y + a.h > groundLevel;
}

function update() {
  if (showFinal) {
    if (Math.random() < 0.2) fireworks.push(createFirework());
    fireworks.forEach(f => f.life--);
    fireworks = fireworks.filter(f => f.life > 0);
    return;
  }

  if (keys["ArrowRight"]) player.x += 5;
  if (keys["ArrowLeft"]) player.x -= 5;
  if ((keys[" "] || keys["ArrowUp"]) && !player.jumping) {
    player.vy = -12;
    player.jumping = true;
  }

  player.vy += gravity;
  player.y += player.vy;

  if (player.y >= groundLevel) {
    player.y = groundLevel;
    player.vy = 0;
    player.jumping = false;
  }

  const p = phases[currentPhase];
  for (let obs of p.obstacles) {
    if (isColliding(player, { x: obs.x, y: groundLevel, w: obs.w, h: 40 })) {
      player.y = groundLevel + 40;
      currentPhase = 1;
      phases[1].questions = [loadRandomPeriferiaQuestion()];
      player.x = 50;
    }
  }

  for (let q of p.questions) {
    if (!q.answered && player.x + player.w > q.x && player.x < q.x + 30) {
      showQuestion(q);
    }
  }

  if (player.x > canvas.width - 50 && !currentQuestion && currentPhase === 0) {
    currentPhase = 1;
    player.x = 50;
  } else if (player.x > canvas.width - 50 && !currentQuestion && currentPhase === 1) {
    currentPhase = 2;
    player.x = 50;
  }
}

function draw() {
  if (showFinal) {
    ctx.fillStyle = "#000";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(images["carteira"], canvas.width/2 - 50, canvas.height/2 - 50, 100, 100);
    ctx.fillStyle = "white";
    ctx.font = "24px sans-serif";
    ctx.fillText("Parabéns! Você conquistou sua Carteira de Trabalho!", 120, 80);
    fireworks.forEach(f => {
      ctx.beginPath();
      ctx.arc(f.x, f.y, f.r, 0, 2 * Math.PI);
      ctx.fillStyle = f.color;
      ctx.fill();
    });
    return;
  }

  const p = phases[currentPhase];
  ctx.drawImage(p.bg, 0, 0, canvas.width, canvas.height);

  ctx.fillStyle = "#654321";
  ctx.fillRect(0, groundLevel + player.h, canvas.width, 100);

  for (let obs of p.obstacles) {
    ctx.drawImage(images["esgoto"], obs.x, groundLevel + player.h, obs.w, 50);
  }

  for (let q of p.questions) {
    if (!q.answered) ctx.drawImage(images["garrafinha"], q.x, groundLevel - 30, 20, 30);
  }

  ctx.drawImage(images["nilo"], player.x, player.y, player.w, player.h);
  ctx.fillStyle = "#000";
  ctx.fillText("Fase: " + p.name, 10, 20);
}

function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}

phases[1].questions = [loadRandomPeriferiaQuestion()];
loop();
</script>
</body>
</html>
